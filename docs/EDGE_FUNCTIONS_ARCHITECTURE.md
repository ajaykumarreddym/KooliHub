# ğŸ—ï¸ KooliHub Edge Functions Architecture

## System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CLIENT APPLICATIONS                            â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   Web App    â”‚  â”‚  Mobile App  â”‚  â”‚  Admin Panel â”‚                 â”‚
â”‚  â”‚   (React)    â”‚  â”‚   (PWA)      â”‚  â”‚   (React)    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         EXPRESS SERVER (PORT 8080)                       â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ API Routes (/api/*)                                                â”‚ â”‚
â”‚  â”‚  â€¢ Product Management  â€¢ Vendor Management  â€¢ Categories           â”‚ â”‚
â”‚  â”‚  â€¢ Custom Fields       â€¢ File Uploads       â€¢ Admin Operations     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Edge Functions Client (server/lib/edge-functions.ts)               â”‚ â”‚
â”‚  â”‚  â€¢ sendNotification()        â€¢ triggerAnalytics()                  â”‚ â”‚
â”‚  â”‚  â€¢ sendOrderNotification()   â€¢ triggerCleanup()                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SUPABASE PLATFORM                                   â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    EDGE FUNCTIONS (Serverless)                      â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  auth-webhook    â”‚  â”‚ send-notificationâ”‚  â”‚  order-webhook   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ User creation  â”‚  â”‚ â€¢ FCM push       â”‚  â”‚ â€¢ Order events   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Email confirm  â”‚  â”‚ â€¢ Multi-device   â”‚  â”‚ â€¢ Status updates â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Profile setup  â”‚  â”‚ â€¢ Topics         â”‚  â”‚ â€¢ Notifications  â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ payment-webhook  â”‚  â”‚scheduled-cleanup â”‚  â”‚analytics-aggreg. â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Razorpay       â”‚  â”‚ â€¢ Expired data   â”‚  â”‚ â€¢ Daily metrics  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Stripe         â”‚  â”‚ â€¢ Old tokens     â”‚  â”‚ â€¢ Revenue stats  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Verification   â”‚  â”‚ â€¢ Cleanup tasks  â”‚  â”‚ â€¢ User activity  â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    POSTGRESQL DATABASE                              â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Tables:                          Triggers:                         â”‚ â”‚
â”‚  â”‚  â€¢ profiles          â€¢ orders     â€¢ order_webhook_on_insert         â”‚ â”‚
â”‚  â”‚  â€¢ fcm_tokens        â€¢ products   â€¢ order_webhook_on_update         â”‚ â”‚
â”‚  â”‚  â€¢ notifications     â€¢ vendors    â€¢ ...                             â”‚ â”‚
â”‚  â”‚  â€¢ daily_analytics   â€¢ ...                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    CRON JOBS (Scheduled Tasks)                      â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  â° 2:00 AM UTC  â†’  scheduled-cleanup                               â”‚ â”‚
â”‚  â”‚  â° 3:00 AM UTC  â†’  analytics-aggregator                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                                    â”‚
                â–¼                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FIREBASE CLOUD MESSAGING   â”‚    â”‚      PAYMENT GATEWAYS               â”‚
â”‚                             â”‚    â”‚                                     â”‚
â”‚  â€¢ Push Notifications       â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â€¢ Device Tokens            â”‚    â”‚  â”‚  Razorpay   â”‚  â”‚   Stripe    â”‚  â”‚
â”‚  â€¢ Topics                   â”‚    â”‚  â”‚  Webhooks   â”‚  â”‚  Webhooks   â”‚  â”‚
â”‚  â€¢ Multi-platform           â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Diagrams

### 1. Order Placement Flow

```
User Places Order
       â”‚
       â–¼
Express Server â†’ Creates order in DB
       â”‚
       â–¼
Database Trigger â†’ Calls order-webhook edge function
       â”‚
       â”œâ”€â”€â†’ Get user's FCM tokens
       â”‚
       â”œâ”€â”€â†’ Call send-notification edge function
       â”‚         â”‚
       â”‚         â”œâ”€â”€â†’ Send to customer: "Order confirmed"
       â”‚         â”‚
       â”‚         â””â”€â”€â†’ Send to vendor: "New order received"
       â”‚
       â””â”€â”€â†’ Return success
```

### 2. Order Status Update Flow

```
Admin Updates Order Status
       â”‚
       â–¼
Express Server â†’ Updates order.status in DB
       â”‚
       â–¼
Database Trigger â†’ Calls order-webhook edge function
       â”‚
       â”œâ”€â”€â†’ Detect status change
       â”‚
       â”œâ”€â”€â†’ Get status message
       â”‚
       â”œâ”€â”€â†’ Call send-notification edge function
       â”‚         â”‚
       â”‚         â””â”€â”€â†’ Notify customer: "Order is out for delivery"
       â”‚
       â””â”€â”€â†’ Log event
```

### 3. Payment Webhook Flow

```
Payment Gateway (Razorpay/Stripe)
       â”‚
       â–¼
Webhook â†’ POST to payment-webhook edge function
       â”‚
       â”œâ”€â”€â†’ Verify webhook signature
       â”‚
       â”œâ”€â”€â†’ Extract payment data
       â”‚
       â”œâ”€â”€â†’ Update order in database
       â”‚         â”‚
       â”‚         â”œâ”€â”€â†’ Set payment_status = 'paid'
       â”‚         â””â”€â”€â†’ Set payment_id, paid_at
       â”‚
       â””â”€â”€â†’ Return 200 OK
```

### 4. Daily Cleanup Flow

```
Cron Job (2:00 AM UTC)
       â”‚
       â–¼
Triggers scheduled-cleanup edge function
       â”‚
       â”œâ”€â”€â†’ Clean expired sessions
       â”‚
       â”œâ”€â”€â†’ Remove old FCM tokens (90+ days)
       â”‚
       â”œâ”€â”€â†’ Delete abandoned carts (30+ days)
       â”‚
       â”œâ”€â”€â†’ Archive old orders (6+ months)
       â”‚
       â”œâ”€â”€â†’ Clean old notifications
       â”‚
       â””â”€â”€â†’ Update statistics
```

### 5. Analytics Aggregation Flow

```
Cron Job (3:00 AM UTC)
       â”‚
       â–¼
Triggers analytics-aggregator edge function
       â”‚
       â”œâ”€â”€â†’ Query yesterday's orders
       â”‚         â”‚
       â”‚         â”œâ”€â”€â†’ Calculate revenue
       â”‚         â”œâ”€â”€â†’ Count orders
       â”‚         â””â”€â”€â†’ Group by service/vendor
       â”‚
       â”œâ”€â”€â†’ Query product performance
       â”‚         â”‚
       â”‚         â””â”€â”€â†’ Top 10 products
       â”‚
       â”œâ”€â”€â†’ Query user activity
       â”‚         â”‚
       â”‚         â”œâ”€â”€â†’ New users
       â”‚         â””â”€â”€â†’ Active users
       â”‚
       â””â”€â”€â†’ Store in daily_analytics table
```

### 6. Push Notification Flow

```
Trigger Event (Order/User/Promo)
       â”‚
       â–¼
Express Server â†’ Calls edge function helper
       â”‚
       â–¼
sendNotificationToUser(userId, title, body)
       â”‚
       â–¼
send-notification edge function
       â”‚
       â”œâ”€â”€â†’ Get user's FCM tokens from DB
       â”‚
       â”œâ”€â”€â†’ Send to Firebase Cloud Messaging
       â”‚         â”‚
       â”‚         â”œâ”€â”€â†’ Device 1: âœ… Success
       â”‚         â”œâ”€â”€â†’ Device 2: âœ… Success
       â”‚         â””â”€â”€â†’ Device 3: âŒ Invalid (mark as inactive)
       â”‚
       â””â”€â”€â†’ Return results
```

## Component Responsibilities

### Express Server
**Role**: Primary API Server
- âœ… Product CRUD operations
- âœ… Vendor management
- âœ… Category management
- âœ… File uploads
- âœ… Admin operations
- âœ… Authentication (Supabase Auth)

### Edge Functions
**Role**: Serverless Workers
- âœ… Push notifications
- âœ… Webhook handlers
- âœ… Background tasks
- âœ… Scheduled maintenance
- âœ… Analytics processing

### Database
**Role**: Data Store
- âœ… All application data
- âœ… Triggers for webhooks
- âœ… RLS policies
- âœ… Stored procedures

### Cron Jobs
**Role**: Schedulers
- âœ… Daily cleanup
- âœ… Daily analytics
- âœ… Periodic maintenance

## Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SECURITY LAYERS                              â”‚
â”‚                                                                      â”‚
â”‚  1. CLIENT LAYER                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚ â€¢ Supabase anon key (public)                             â”‚   â”‚
â”‚     â”‚ â€¢ JWT authentication                                      â”‚   â”‚
â”‚     â”‚ â€¢ HTTPS only                                              â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â”‚  2. EXPRESS SERVER LAYER                                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚ â€¢ JWT verification                                        â”‚   â”‚
â”‚     â”‚ â€¢ Role-based access (requireAdmin)                        â”‚   â”‚
â”‚     â”‚ â€¢ Rate limiting                                           â”‚   â”‚
â”‚     â”‚ â€¢ CORS policies                                           â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â”‚  3. EDGE FUNCTIONS LAYER                                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚ â€¢ JWT verification (enabled)                              â”‚   â”‚
â”‚     â”‚ â€¢ Service role key (secure)                               â”‚   â”‚
â”‚     â”‚ â€¢ Webhook signature verification                          â”‚   â”‚
â”‚     â”‚ â€¢ CORS headers                                            â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â”‚  4. DATABASE LAYER                                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚ â€¢ Row Level Security (RLS)                                â”‚   â”‚
â”‚     â”‚ â€¢ Policy-based access                                     â”‚   â”‚
â”‚     â”‚ â€¢ User-based filtering                                    â”‚   â”‚
â”‚     â”‚ â€¢ Encrypted connections                                   â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Scalability Design

### Horizontal Scaling
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Region    â”‚   â”‚   Region    â”‚   â”‚   Region    â”‚
â”‚   US-EAST   â”‚   â”‚   EU-WEST   â”‚   â”‚   ASIA-SE   â”‚
â”‚             â”‚   â”‚             â”‚   â”‚             â”‚
â”‚ Edge Func 1 â”‚   â”‚ Edge Func 1 â”‚   â”‚ Edge Func 1 â”‚
â”‚ Edge Func 2 â”‚   â”‚ Edge Func 2 â”‚   â”‚ Edge Func 2 â”‚
â”‚ Edge Func 3 â”‚   â”‚ Edge Func 3 â”‚   â”‚ Edge Func 3 â”‚
â”‚     ...     â”‚   â”‚     ...     â”‚   â”‚     ...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚                 â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Supabase DB     â”‚
              â”‚  (PostgreSQL)    â”‚
              â”‚  with replicas   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Load Distribution
- **Edge Functions**: Auto-scale per region
- **Database**: Connection pooling + read replicas
- **Express Server**: Can scale horizontally (multiple instances)
- **Cron Jobs**: Single instance (Supabase manages)

## Cost Structure

### Free Tier Limits
- **Edge Functions**: 500K requests/month FREE
- **Database**: 500MB storage FREE
- **Auth**: Unlimited users
- **Storage**: 1GB FREE

### Estimated Monthly Usage
```
Component              Requests/Month    Cost
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
send-notification      ~50,000           FREE
order-webhook          ~10,000           FREE
payment-webhook        ~5,000            FREE
scheduled-cleanup      30 (daily)        FREE
analytics-aggregator   30 (daily)        FREE
auth-webhook           ~2,000            FREE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOTAL                  ~67,000           FREE âœ…
```

## Monitoring Dashboard

### Key Metrics to Track
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EDGE FUNCTIONS HEALTH DASHBOARD                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ“Š Invocations (24h)                                       â”‚
â”‚  â”œâ”€ send-notification:        1,234 (99.9% success)        â”‚
â”‚  â”œâ”€ order-webhook:              234 (100% success)          â”‚
â”‚  â”œâ”€ payment-webhook:             45 (100% success)          â”‚
â”‚  â”œâ”€ scheduled-cleanup:            1 (100% success)          â”‚
â”‚  â””â”€ analytics-aggregator:         1 (100% success)          â”‚
â”‚                                                             â”‚
â”‚  âš¡ Performance                                              â”‚
â”‚  â”œâ”€ Avg Response Time:       87ms                          â”‚
â”‚  â”œâ”€ P95 Response Time:      142ms                          â”‚
â”‚  â””â”€ Error Rate:             0.1%                           â”‚
â”‚                                                             â”‚
â”‚  ğŸ’¾ Database                                                 â”‚
â”‚  â”œâ”€ Queries/sec:            45                             â”‚
â”‚  â”œâ”€ Connection Pool:        85% used                       â”‚
â”‚  â””â”€ Storage Used:          245 MB / 500 MB                 â”‚
â”‚                                                             â”‚
â”‚  ğŸ”” Notifications (24h)                                     â”‚
â”‚  â”œâ”€ Sent:                  1,234                           â”‚
â”‚  â”œâ”€ Delivered:             1,189 (96.4%)                   â”‚
â”‚  â””â”€ Failed:                   45 (3.6%)                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Disaster Recovery

### Backup Strategy
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKUP & RECOVERY                                           â”‚
â”‚                                                             â”‚
â”‚  Database Backups:                                          â”‚
â”‚  â”œâ”€ Continuous (Point-in-time recovery)                    â”‚
â”‚  â”œâ”€ Daily automated backups (7 days retention)             â”‚
â”‚  â””â”€ Weekly backups (30 days retention)                     â”‚
â”‚                                                             â”‚
â”‚  Edge Functions:                                            â”‚
â”‚  â”œâ”€ Version controlled (Git)                               â”‚
â”‚  â”œâ”€ Instant rollback capability                            â”‚
â”‚  â””â”€ Blue-green deployment                                  â”‚
â”‚                                                             â”‚
â”‚  Recovery Time Objective (RTO):    < 5 minutes             â”‚
â”‚  Recovery Point Objective (RPO):   < 1 minute              â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Development Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Develop    â”‚  Write edge function code
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Test Local â”‚  Test with local Supabase
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Deploy     â”‚  Deploy to Supabase
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Monitor    â”‚  Check logs & metrics
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Optimize   â”‚  Improve performance
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Architecture Version**: 1.0  
**Last Updated**: 2024-11-16  
**Status**: Production Ready âœ…  
**Total Functions**: 6  
**Total Tables**: 8  
**Cron Jobs**: 2

